{{define "topics-content"}}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <h2>Topics</h2>
    <a href="/topics/new" class="btn btn-primary">Create New Topic</a>
</div>

<div style="margin-bottom: 1rem;">
    <div class="form-group">
        <label for="filter">Filter by type:</label>
        <select id="filter" class="form-control" style="max-width: 200px; display: inline-block;" onchange="filterTopics(this.value)">
            <option value="">All Types</option>
            <option value="external" {{if eq .TopicFilter "external"}}selected{{end}}>External</option>
            <option value="internal" {{if eq .TopicFilter "internal"}}selected{{end}}>Internal</option>
            <option value="system" {{if eq .TopicFilter "system"}}selected{{end}}>System</option>
        </select>
    </div>
</div>

{{if .Topics}}
<div class="card">
    <div class="card-body">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Last Value</th>
                    <th>Last Updated</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {{range $name, $topic := .Topics}}
                <tr>
                    <td><strong>{{$name}}</strong></td>
                    <td><span class="topic-type topic-type-{{$topic.Type}}">{{$topic.Type}}</span></td>
                    <td style="max-width: 300px;">
                        {{if $topic.LastValue}}
                        {{$json := toJSON $topic.LastValue}}
                        {{if gt (len $json) 100}}
                        <div class="value-container">
                            <code class="value-short">{{truncate $json 100}}</code>
                            <code class="value-full" style="display: none; word-wrap: break-word; white-space: pre-wrap;">{{$json}}</code>
                            <button class="btn-expand" onclick="toggleValue(this)" style="margin-left: 5px; font-size: 12px;">Expand</button>
                        </div>
                        {{else}}
                        <code style="word-wrap: break-word;">{{$json}}</code>
                        {{end}}
                        {{else}}
                        <em>null</em>
                        {{end}}
                    </td>
                    <td>
                        {{if not $topic.LastUpdated.IsZero}}
                        {{$topic.LastUpdated.Format "2006-01-02 15:04:05"}}
                        {{else}}
                        <em>Never</em>
                        {{end}}
                    </td>
                    <td>
                        {{if eq $topic.Type "internal"}}
                        <a href="/topics/edit/{{$name}}" class="btn btn-secondary btn-sm">Edit</a>
                        <form method="post" action="/topics/delete/{{$name}}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this topic?')">
                            <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                        </form>
                        {{else}}
                        <span class="text-muted">Read-only</span>
                        {{end}}
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>
</div>
{{else}}
<div class="card">
    <div class="card-body">
        <p>No topics found. <a href="/topics/new">Create your first topic</a>.</p>
    </div>
</div>
{{end}}

<script>
function filterTopics(type) {
    const url = new URL(window.location);
    if (type) {
        url.searchParams.set('filter', type);
    } else {
        url.searchParams.delete('filter');
    }
    window.location = url;
}

function toggleValue(button) {
    const container = button.parentElement;
    const shortValue = container.querySelector('.value-short');
    const fullValue = container.querySelector('.value-full');

    if (shortValue.style.display === 'none') {
        // Show short, hide full
        shortValue.style.display = 'inline';
        fullValue.style.display = 'none';
        button.textContent = 'Expand';
    } else {
        // Hide short, show full
        shortValue.style.display = 'none';
        fullValue.style.display = 'block';
        button.textContent = 'Collapse';
    }
}
</script>
{{end}}