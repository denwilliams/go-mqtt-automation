{{define "topic-edit-content"}}
<h2>{{if .IsNew}}Create New Topic{{else}}Edit Topic{{end}}</h2>

<div class="card">
    <div class="card-body">
        <form method="post">
            <div class="form-group">
                <label for="name">Topic Name *</label>
                <input type="text" id="name" name="name" class="form-control" 
                       {{if not .IsNew}}value="{{.Topic.Name}}" readonly{{end}} 
                       placeholder="e.g., home/temperature/average" required>
                <small>Use forward slashes to create hierarchical topic names</small>
            </div>

            <div class="form-group">
                <label for="inputs">Input Topics</label>
                <textarea id="inputs" name="inputs" class="form-control" rows="4"
                          placeholder="Enter one topic per line, e.g.:&#10;sensors/temperature/living-room&#10;sensors/temperature/bedroom">{{if not .IsNew}}{{range .Topic.GetInputs}}{{.}}
{{end}}{{end}}</textarea>
                <small>List the topics this internal topic should listen to (one per line)</small>
            </div>

            <div class="form-group">
                <label for="input_names">Input Names (Optional)</label>
                <textarea id="input_names" name="input_names" class="form-control" rows="4"
                          placeholder="Optional: Give friendly names to inputs in JSON format:&#10;{&#10;  &quot;sensors/temperature/living-room&quot;: &quot;living_temp&quot;,&#10;  &quot;sensors/temperature/bedroom&quot;: &quot;bedroom_temp&quot;&#10;}">{{if and (not .IsNew) .Topic.GetInputNames (gt (len .Topic.GetInputNames) 0)}}{{toJSON .Topic.GetInputNames}}{{else}}{}{{end}}</textarea>
                <small>Map topic paths to friendly names for easier access in strategy code (e.g., context.inputs['living_temp'])</small>
            </div>

            <div class="form-group">
                <label for="strategy_id">Strategy *</label>
                {{if .SelectedStrategy}}
                <div class="form-control-static">
                    <strong>{{.SelectedStrategy.Name}}</strong> ({{.SelectedStrategy.Language}})
                    {{if gt .SelectedStrategy.MaxInputs 0}} - Max {{.SelectedStrategy.MaxInputs}} inputs{{else}} - Unlimited inputs{{end}}
                    <input type="hidden" id="strategy_id" name="strategy_id" value="{{.SelectedStrategy.ID}}">
                    <br><small><a href="/topics/new">Choose a different strategy</a></small>
                </div>
                {{else}}
                <select id="strategy_id" name="strategy_id" class="form-control" required>
                    <option value="">Select a strategy...</option>
                    {{range .Strategies}}
                    <option value="{{.ID}}"
                            data-max-inputs="{{.MaxInputs}}"
                            data-default-input-names="{{toJSON .DefaultInputNames}}"
                            {{if and (not $.IsNew) (eq $.Topic.GetStrategyID .ID)}}selected{{end}}>
                        {{.Name}} ({{.Language}}){{if gt .MaxInputs 0}} - Max {{.MaxInputs}} inputs{{else}} - Unlimited inputs{{end}}
                    </option>
                    {{end}}
                </select>
                {{end}}
                <small>The strategy defines how this topic processes its inputs</small>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" name="emit_to_mqtt" {{if and (not .IsNew) .Topic.ShouldEmitToMQTT}}checked{{end}}>
                    Emit to MQTT
                </label>
                <small>When checked, the topic's output will be published to the MQTT broker</small>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" name="noop_unchanged" {{if and (not .IsNew) .Topic.IsNoOpUnchanged}}checked{{end}}>
                    Skip unchanged values
                </label>
                <small>When checked, the topic won't trigger if the output value hasn't changed</small>
            </div>

            <div style="margin-top: 2rem;">
                <button type="submit" class="btn btn-primary">
                    {{if .IsNew}}Create Topic{{else}}Update Topic{{end}}
                </button>
                <a href="/topics" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>

{{if .Strategies}}
<div class="card" style="margin-top: 2rem;">
    <div class="card-header">
        <h3>Available Strategies</h3>
    </div>
    <div class="card-body">
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Language</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                {{range .Strategies}}
                <tr>
                    <td><strong>{{.Name}}</strong></td>
                    <td><span class="topic-type topic-type-system">{{.Language}}</span></td>
                    <td>
                        {{if gt (len .Code) 100}}
                        {{slice .Code 0 100}}...
                        {{else}}
                        {{.Code}}
                        {{end}}
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
        <p><a href="/strategies/new">Create a new strategy</a> if none of the above meet your needs.</p>
    </div>
</div>
{{end}}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const strategySelect = document.getElementById('strategy_id');
    const inputNamesTextarea = document.getElementById('input_names');
    const inputsTextarea = document.getElementById('inputs');

    // Default input names for pre-selected strategy
    {{if .SelectedStrategy}}
    const selectedStrategyDefaultInputNames = {{toJSON .SelectedStrategy.DefaultInputNames}};
    {{end}}

    function updateInputNamesFromStrategy() {
        // Only auto-populate if the input names field is empty or contains default empty JSON
        const currentInputNames = inputNamesTextarea.value.trim();
        const isEmptyOrDefault = currentInputNames === '' || currentInputNames === '{}';

        // For existing topics, only auto-populate if the field is empty/default
        {{if not .IsNew}}
        if (!isEmptyOrDefault) {
            return; // Don't overwrite existing custom input names
        }
        {{end}}

        let defaultInputNames = null;

        // Get default input names from selected strategy or dropdown
        {{if .SelectedStrategy}}
        defaultInputNames = selectedStrategyDefaultInputNames;
        {{else}}
        if (strategySelect && strategySelect.selectedIndex >= 0) {
            const selectedOption = strategySelect.options[strategySelect.selectedIndex];
            if (selectedOption.value !== '') {
                const defaultInputNamesStr = selectedOption.getAttribute('data-default-input-names');
                if (defaultInputNamesStr && defaultInputNamesStr !== '[]' && defaultInputNamesStr !== 'null') {
                    try {
                        defaultInputNames = JSON.parse(defaultInputNamesStr);
                    } catch (e) {
                        console.error('Error parsing default input names:', e);
                        return;
                    }
                }
            }
        }
        {{end}}

        if (defaultInputNames && defaultInputNames.length > 0) {
            const inputTopics = inputsTextarea.value.split('\n').map(s => s.trim()).filter(s => s !== '');

            if (inputTopics.length > 0) {
                // Create input names mapping using the first N topics
                const inputNamesObj = {};
                for (let i = 0; i < Math.min(defaultInputNames.length, inputTopics.length); i++) {
                    inputNamesObj[inputTopics[i]] = defaultInputNames[i];
                }

                inputNamesTextarea.value = JSON.stringify(inputNamesObj, null, 2);
            }
        }
    }

    // Add event listeners only if elements exist
    if (strategySelect) {
        strategySelect.addEventListener('change', updateInputNamesFromStrategy);
    }
    if (inputsTextarea) {
        inputsTextarea.addEventListener('blur', updateInputNamesFromStrategy);
        // Also trigger on initial load if strategy is pre-selected
        {{if .SelectedStrategy}}
        setTimeout(updateInputNamesFromStrategy, 100);
        {{end}}
    }
});
</script>
{{end}}